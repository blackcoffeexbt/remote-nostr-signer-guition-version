<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Nostr Remote Signer: Nostr Remote Signer Device Architecture</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Nostr Remote Signer<span id="projectnumber">&#160;v1.0.0</span>
   </div>
   <div id="projectbrief">A NIP46 remote signer for Nostr running on the Guition 3.5inch touch display board.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md__a_r_c_h_i_t_e_c_t_u_r_e.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Nostr Remote Signer Device Architecture </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md14"></a>
Project Overview</h1>
<p>This is a <b>Nostr Remote Signer device</b> built for the ESP32-S3 Guition JC3248W535 touch screen display. The device implements NIP-46 (Nostr Connect) protocol to provide secure remote signing services for Nostr events while keeping private keys isolated on the hardware device.</p>
<h2><a class="anchor" id="autotoc_md15"></a>
Key Features</h2>
<ul>
<li>NIP-46 (Nostr Connect) remote signer implementation</li>
<li>Hardware-isolated private key storage</li>
<li>Touch screen interface for user confirmation</li>
<li>Client authorization management</li>
<li>Event signing with user approval</li>
<li>WiFi connectivity for Nostr relay communication</li>
<li>Real-time signing request notifications</li>
</ul>
<h2><a class="anchor" id="autotoc_md16"></a>
Technology Stack</h2>
<ul>
<li><b>Device</b>: ESP32-S3 Guition JC3248W535 with 3.5" touch screen display (320x480)</li>
<li><b>GUI Framework</b>: LVGL (Light and Versatile Graphics Library)</li>
<li><b><a class="el" href="namespace_display.html">Display</a> Driver</b>: LovyanGFX</li>
<li><b>Protocols</b>: Nostr (NIP-01, NIP-44, NIP-46), WebSocket, NTP</li>
<li><b>Cryptography</b>: Secp256k1 with Schnorr signatures, NIP-44 encryption</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md18"></a>
Architecture Overview</h1>
<p>The application follows a <b>modular architecture</b> with clear separation of concerns. The <code><a class="el" href="namespace_app.html">App</a></code> namespace serves as the central coordinator, managing initialization, inter-module communication, and application lifecycle.</p>
<div class="fragment"><div class="line">┌─────────────────┐</div>
<div class="line">│      App        │  ← Central coordinator</div>
<div class="line">│   (app.cpp)     │</div>
<div class="line">└─────┬───────────┘</div>
<div class="line">      │</div>
<div class="line">┌─────┴───────────────────────────────────────┐</div>
<div class="line">│  Module Layer                               │</div>
<div class="line">├─────────┬─────────┬─────────┬─────────┬──────────────┐</div>
<div class="line">│Display  │Settings │WiFiMgr  │   UI    │RemoteSigner  │</div>
<div class="line">│         │         │         │         │              │</div>
<div class="line">└─────────┴─────────┴─────────┴─────────┴──────────────┘</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md20"></a>
File Structure and Module Descriptions</h1>
<h2><a class="anchor" id="autotoc_md21"></a>
Core Application Files</h2>
<h3><a class="anchor" id="autotoc_md22"></a>
&lt;tt&gt;src/main.cpp&lt;/tt&gt;</h3>
<p><b>Entry point and main loop controller</b></p><ul>
<li>Initializes the entire application via <code><a class="el" href="namespace_app.html#a36c71ca6134247ab51d1a7a2d0a02cd4">App::init()</a></code></li>
<li>Runs the main event loop processing LVGL and application modules</li>
<li>Manages legacy WiFi connection timeouts and status checking</li>
<li>Creates task communication queues for modular operation</li>
</ul>
<p><b>Key Functions:</b></p><ul>
<li><code><a class="el" href="main_8cpp.html#a7dfd9b79bc5a37d7df40207afbc5431f">setup()</a></code>: System initialization and module startup</li>
<li><code><a class="el" href="main_8cpp.html#a0b33edabd7f1c4e4a0bf32c67269be2f">loop()</a></code>: Main application event loop</li>
<li><code>wifi_main_status_updater_cb()</code>: WiFi connection timeout handling</li>
</ul>
<h3><a class="anchor" id="autotoc_md23"></a>
&lt;tt&gt;src/app.cpp&lt;/tt&gt; / &lt;tt&gt;src/app.h&lt;/tt&gt;</h3>
<p><b>Central application coordinator and state manager</b></p><ul>
<li>Coordinates initialization and cleanup of all modules</li>
<li>Manages application state transitions and error handling</li>
<li>Implements deep sleep power management with GPIO wake-up</li>
<li>Provides inter-module communication via event callbacks</li>
<li>Handles system health monitoring and status reporting</li>
</ul>
<p><b>Key Functions:</b></p><ul>
<li><code>init()</code>: Initialize all modules in dependency order</li>
<li><code>run()</code>: Main application loop with health checks</li>
<li><code>notifyWiFiStatusChanged()</code>: Coordinate WiFi state changes</li>
<li><code>notifyNWCStatusChanged()</code>: Handle NWC connection events</li>
<li><code>enterSleepMode()</code>/<code>exitSleepMode()</code>: Power management</li>
<li><code>checkModuleHealth()</code>: System diagnostics</li>
</ul>
<p><b>Power Management:</b></p><ul>
<li>Configures GPIO 12 as wake-up pin</li>
<li>Implements 30-second inactivity timeout</li>
<li>Handles wake-up reason detection and display backlight control</li>
</ul>
<h2><a class="anchor" id="autotoc_md24"></a>
Display and UI Modules</h2>
<h3><a class="anchor" id="autotoc_md25"></a>
&lt;tt&gt;src/display.cpp&lt;/tt&gt; / &lt;tt&gt;src/display.h&lt;/tt&gt;</h3>
<p><b>Hardware display driver and LVGL integration</b></p><ul>
<li>Custom LGFX driver implementation for WT32-SC01</li>
<li>Configures ST7796 display controller and FT5x06 touch controller</li>
<li>Provides LVGL display and input device callbacks</li>
<li>Manages display backlight and power states</li>
<li>Implements QR code rendering for Lightning invoices</li>
</ul>
<p><b>Key Functions:</b></p><ul>
<li><code>init()</code>: Hardware initialization and LVGL setup</li>
<li><code>displayFlush()</code>: LVGL display callback</li>
<li><code>touchpadRead()</code>: LVGL touch input callback</li>
<li><code>displayQRCode()</code>: Lightning invoice QR code generation</li>
<li><code>turnOffBacklight()</code>/<code>turnOnBacklight()</code>: Power management</li>
</ul>
<h3><a class="anchor" id="autotoc_md26"></a>
&lt;tt&gt;src/ui.cpp&lt;/tt&gt; / &lt;tt&gt;src/ui.h&lt;/tt&gt;</h3>
<p><b>User interface screens and interaction handling</b></p><ul>
<li>Implements multiple screen states (keypad, settings, WiFi, etc.)</li>
<li>Creates and manages LVGL <a class="el" href="namespace_u_i.html">UI</a> elements and layouts</li>
<li>Handles user input events and navigation</li>
<li>Manages invoice overlay display and payment confirmation</li>
<li>Provides message dialogs and status updates</li>
</ul>
<p><b>Screen Types:</b></p><ul>
<li><code>SCREEN_KEYPAD</code>: Main payment amount entry screen</li>
<li><code>SCREEN_SETTINGS</code>: Configuration and preferences</li>
<li><code>SCREEN_WIFI</code>: WiFi network selection and management</li>
<li><code>SCREEN_WIFI_PASSWORD</code>: Network password entry</li>
<li><code>SCREEN_INFO</code>: System information and diagnostics</li>
</ul>
<p><b>Key Functions:</b></p><ul>
<li><code>createKeypadScreen()</code>: Main POS interface</li>
<li><code>createInvoiceOverlay()</code>: Payment QR code display</li>
<li><code>updateInvoiceDisplay()</code>: Real-time invoice updates</li>
<li><code>showPaymentReceived()</code>: Payment confirmation <a class="el" href="namespace_u_i.html">UI</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md27"></a>
Connectivity Modules</h2>
<h3><a class="anchor" id="autotoc_md28"></a>
&lt;tt&gt;src/wifi.cpp&lt;/tt&gt; / &lt;tt&gt;src/wifi.h&lt;/tt&gt;</h3>
<p><b>WiFi connection and access point management</b></p><ul>
<li>Manages WiFi station and AP mode operation</li>
<li>Implements credential storage and auto-connection</li>
<li>Provides network scanning and connection status monitoring</li>
<li>Creates configuration web server in AP mode</li>
<li>Integrates with <a class="el" href="namespace_settings.html">Settings</a> module for network persistence</li>
</ul>
<p><b>Key Functions:</b></p><ul>
<li><code>startConnection()</code>: Connect to saved or new network</li>
<li><code>startAPMode()</code>: Enable configuration access point</li>
<li><code>processScanResults()</code>: Handle network discovery</li>
<li><code>saveCredentials()</code>: Store network authentication</li>
<li><code>setStatusCallback()</code>: Integration with <a class="el" href="namespace_app.html">App</a> coordinator</li>
</ul>
<p><b>AP Mode Configuration:</b></p><ul>
<li>Creates web server for device setup</li>
<li>Handles NWC URL configuration via web interface</li>
<li>Provides WiFi network selection and credential entry</li>
</ul>
<h3><a class="anchor" id="autotoc_md29"></a>
&lt;tt&gt;src/remote_signer.cpp&lt;/tt&gt; / &lt;tt&gt;src/remote_signer.h&lt;/tt&gt;</h3>
<p><b>NIP-46 Remote Signer protocol implementation</b></p><ul>
<li>Implements NIP-46 (Nostr Connect) protocol over WebSocket connections</li>
<li>Handles Nostr event encryption/decryption using NIP-44</li>
<li>Manages client authorization and event signing requests</li>
<li>Provides secure private key storage and management</li>
<li>Implements automatic reconnection and connection health monitoring</li>
</ul>
<p><b>Key Functions:</b></p><ul>
<li><code>connectToRelay()</code>: Establish WebSocket connection to Nostr relay</li>
<li><code>handleSigningRequestEvent()</code>: Process incoming signing requests</li>
<li><code>handleConnect()</code>: Handle client connection requests</li>
<li><code>handleSignEvent()</code>: Process event signing requests with user confirmation</li>
<li><code>loadConfigFromPreferences()</code>: Load signer configuration</li>
<li><code>websocketEvent()</code>: Handle WebSocket events and Nostr messages</li>
</ul>
<p><b>Protocol Features:</b></p><ul>
<li>Full NIP-46 method support (connect, sign_event, get_public_key, etc.)</li>
<li>NIP-44 encryption for all client communications</li>
<li>Client authorization management with user approval</li>
<li>Event signing confirmation via touch interface</li>
<li>Hardware-isolated private key storage</li>
</ul>
<h2><a class="anchor" id="autotoc_md30"></a>
Configuration and Storage</h2>
<h3><a class="anchor" id="autotoc_md31"></a>
&lt;tt&gt;src/settings.cpp&lt;/tt&gt; / &lt;tt&gt;src/settings.h&lt;/tt&gt;</h3>
<p><b>Application settings and persistent storage</b></p><ul>
<li>Manages device configuration using ESP32 Preferences</li>
<li>Handles shop name, currency selection, and AP password</li>
<li>Provides PIN-based security for settings access</li>
<li>Integrates with <a class="el" href="namespace_u_i.html">UI</a> module for settings screens</li>
<li>Supports factory reset functionality</li>
</ul>
<p><b>Key Functions:</b></p><ul>
<li><code>loadFromPreferences()</code>/<code>saveToPreferences()</code>: Persistence</li>
<li><code>setShopName()</code>/<code>getShopName()</code>: Merchant identification</li>
<li><code>setCurrency()</code>/<code>getCurrency()</code>: Payment currency selection</li>
<li><code>verifyPin()</code>: Security access control</li>
<li><code>resetToDefaults()</code>: Factory reset</li>
</ul>
<h3><a class="anchor" id="autotoc_md32"></a>
&lt;tt&gt;src/config.h&lt;/tt&gt;</h3>
<p><b>System constants and configuration definitions</b></p><ul>
<li><a class="el" href="namespace_display.html">Display</a> resolution and buffer size constants</li>
<li>WiFi timeout and connection parameters</li>
<li>Screen state enumeration</li>
<li>Hardware-specific configurations</li>
</ul>
<h2><a class="anchor" id="autotoc_md33"></a>
External Libraries</h2>
<h3><a class="anchor" id="autotoc_md34"></a>
&lt;tt&gt;lib/TFT_eSPI/&lt;/tt&gt;</h3>
<p><b>Enhanced display driver library</b></p><ul>
<li>Comprehensive TFT display driver with touch support</li>
<li>Multiple display controller support (ST7796, ILI9341, etc.)</li>
<li>Font rendering and graphics primitives</li>
<li>Hardware-specific optimizations for ESP32</li>
</ul>
<h3><a class="anchor" id="autotoc_md35"></a>
&lt;tt&gt;lib/aes/&lt;/tt&gt;</h3>
<p><b>AES encryption implementation</b></p><ul>
<li>Provides cryptographic functions for secure communication</li>
<li>Used by NWC module for Nostr message encryption</li>
</ul>
<h3><a class="anchor" id="autotoc_md36"></a>
&lt;tt&gt;lib/nostr/&lt;/tt&gt;</h3>
<p><b>Nostr protocol implementation</b></p><ul>
<li>NIP-19 bech32 encoding/decoding (<code><a class="el" href="nip19_8cpp.html">nip19.cpp</a></code>)</li>
<li>NIP-44 encryption for secure messaging (<code>nip44/</code>)</li>
<li>Nostr event creation and verification (<code><a class="el" href="nostr_8cpp.html">nostr.cpp</a></code>)</li>
<li>Integration with Bitcoin cryptographic functions</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md38"></a>
Data Flow and Module Interactions</h1>
<h2><a class="anchor" id="autotoc_md39"></a>
1. &lt;strong&gt;Application Startup&lt;/strong&gt;</h2>
<div class="fragment"><div class="line">main.cpp → App::init() → Display::init() → Settings::init() → WiFiManager::init() → UI::init() → RemoteSigner::init()</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md40"></a>
2. &lt;strong&gt;Client Connection Flow&lt;/strong&gt;</h2>
<div class="fragment"><div class="line">Client application → NIP-46 connect request → RemoteSigner::handleConnect() → </div>
<div class="line">UI authorization prompt → User approval → RemoteSigner::sendResponse() → Client authorized</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md41"></a>
3. &lt;strong&gt;Event Signing Flow&lt;/strong&gt;</h2>
<div class="fragment"><div class="line">Authorized client → NIP-46 sign_event request → RemoteSigner::handleSignEvent() → </div>
<div class="line">UI signing confirmation → User approval → Event signed → Encrypted response to client</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md42"></a>
4. &lt;strong&gt;WiFi Configuration Flow&lt;/strong&gt;</h2>
<div class="fragment"><div class="line">UI (WiFi screen) → WiFiManager::startScan() → UI (network list) → </div>
<div class="line">WiFiManager::startConnection() → App::notifyWiFiStatusChanged() → RemoteSigner::connectToRelay()</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md43"></a>
5. &lt;strong&gt;Settings Management Flow&lt;/strong&gt;</h2>
<div class="fragment"><div class="line">UI (settings screen) → Settings::saveToPreferences() → </div>
<div class="line">App state update → UI refresh</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md45"></a>
Communication Protocols</h1>
<h2><a class="anchor" id="autotoc_md46"></a>
NIP-46 (Nostr Connect) Protocol</h2>
<ul>
<li><b>WebSocket connection</b> to Nostr relay servers</li>
<li><b>Encrypted messaging</b> using NIP-44 encryption</li>
<li><b>Event types</b>: Kind 24133 for remote signer requests and responses</li>
<li><b>Method support</b>: connect, sign_event, get_public_key, ping, nip04/nip44 encrypt/decrypt</li>
</ul>
<h2><a class="anchor" id="autotoc_md47"></a>
Nostr Protocol Integration</h2>
<ul>
<li><b>Event signing</b> with secp256k1 Schnorr signatures</li>
<li><b>Real-time communication</b> via WebSocket connections to relays</li>
<li><b>Client authorization</b> with persistent storage of approved clients</li>
</ul>
<h2><a class="anchor" id="autotoc_md48"></a>
External APIs</h2>
<ul>
<li><b>NTP synchronization</b> for accurate timestamps</li>
<li><b>HTTPS requests</b> for secure API communication</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md50"></a>
Hardware Configuration</h1>
<h2><a class="anchor" id="autotoc_md51"></a>
ESP32 Pin Mapping</h2>
<ul>
<li><b>GPIO 12</b>: Wake-up button for deep sleep</li>
<li><b><a class="el" href="namespace_display.html">Display</a> interface</b>: Parallel 8-bit bus (ST7796)</li>
<li><b>Touch interface</b>: I2C (FT5x06)</li>
<li><b>WiFi</b>: Built-in ESP32 radio</li>
</ul>
<h2><a class="anchor" id="autotoc_md52"></a>
Power Management</h2>
<ul>
<li><b>Deep sleep mode</b> with GPIO wake-up</li>
<li><b><a class="el" href="namespace_display.html">Display</a> backlight control</b> for power saving</li>
<li><b>30-second inactivity timeout</b> (configurable)</li>
<li><b>RTC GPIO configuration</b> for wake-up functionality</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md54"></a>
Security Features</h1>
<h2><a class="anchor" id="autotoc_md55"></a>
Cryptographic Security</h2>
<ul>
<li><b>secp256k1 key pairs</b> for Nostr identity and event signing</li>
<li><b>NIP-44 encryption</b> for all client communications</li>
<li><b>Hardware-isolated private keys</b> never leave the device</li>
<li><b>PIN protection</b> for settings access</li>
<li><b>Secure storage</b> of credentials in ESP32 Preferences</li>
</ul>
<h2><a class="anchor" id="autotoc_md56"></a>
Network Security</h2>
<ul>
<li><b>HTTPS/WSS connections</b> for all external communications</li>
<li><b>Encrypted Nostr messaging</b> using NIP-44 standard</li>
<li><b>Client authorization</b> requiring user approval for each connection</li>
<li><b>Event signing confirmation</b> requiring user approval for each request</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md58"></a>
Development and Build</h1>
<h2><a class="anchor" id="autotoc_md59"></a>
PlatformIO Configuration</h2>
<ul>
<li><b>ESP32 development board</b> target</li>
<li><b>Arduino framework</b> with ESP-IDF components</li>
<li><b>Library dependencies</b> managed via platformio.ini</li>
<li><b>Build flags</b> for debugging and optimization</li>
</ul>
<h2><a class="anchor" id="autotoc_md60"></a>
Key Dependencies</h2>
<ul>
<li><code>lovyan03/LovyanGFX@^0.4.14</code>: <a class="el" href="namespace_display.html">Display</a> driver</li>
<li><code>lvgl/lvgl@^8.1.0</code>: GUI framework</li>
<li><code>lnbits/Nostr@^0.2.0</code>: Nostr protocol implementation</li>
<li><code>micro-bitcoin/uBitcoin</code>: Bitcoin cryptographic functions</li>
<li><code>bblanchon/ArduinoJson@^6.21.0</code>: JSON processing</li>
<li><code>links2004/WebSockets@^2.3.7</code>: WebSocket client </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6 </li>
  </ul>
</div>
</body>
</html>
